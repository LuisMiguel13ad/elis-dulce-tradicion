---
phase: 02-verify-order-emails
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/02-verify-order-emails/02-TROUBLESHOOTING.md
  - .planning/phases/02-verify-order-emails/02-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "Order confirmation email arrives within 60 seconds of placing order"
    - "Ready notification email arrives within 60 seconds of status change to ready"
    - "English orders receive English emails"
    - "Spanish orders receive Spanish emails"
    - "Pickup orders show pickup location in ready email"
    - "Delivery orders show delivery address in ready email"
    - "Emails do not land in spam folder"
  artifacts:
    - path: ".planning/phases/02-verify-order-emails/02-TROUBLESHOOTING.md"
      provides: "Reusable debugging guide for email issues"
      min_lines: 50
    - path: ".planning/phases/02-verify-order-emails/02-VERIFICATION.md"
      provides: "Test results documentation"
      min_lines: 30
  key_links:
    - from: "Order creation (POST /api/v1/orders)"
      to: "send-order-confirmation Edge Function"
      via: "sendOrderConfirmationEmail() in backend/utils/edgeFunctions.ts"
      pattern: "sendOrderConfirmationEmail"
    - from: "Status change to ready (PATCH /api/v1/orders/:id/status)"
      to: "send-ready-notification Edge Function"
      via: "sendReadyNotificationEmail() in backend/utils/edgeFunctions.ts"
      pattern: "sendReadyNotificationEmail"
---

<objective>
Verify order confirmation and ready notification emails work end-to-end across all language and delivery option combinations.

Purpose: Confirm existing email infrastructure works correctly before considering Phase 2 complete. This is verification work, not feature development.

Output: Verified email functionality with documented test results and troubleshooting guide.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 1 established patterns
@.planning/phases/01-contact-form-emails/01-01-SUMMARY.md

# Research contains test matrix and troubleshooting steps
@.planning/phases/02-verify-order-emails/02-RESEARCH.md

# Key implementation files
@backend/routes/orders.js
@backend/utils/edgeFunctions.ts
@supabase/functions/send-order-confirmation/index.ts
@supabase/functions/send-ready-notification/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-flight checks and infrastructure verification</name>
  <files>N/A (verification commands only)</files>
  <action>
Verify email infrastructure is ready before manual testing:

1. Check Supabase Edge Functions are deployed:
   - Run: `supabase functions list` (or check via Supabase Dashboard)
   - Verify `send-order-confirmation` and `send-ready-notification` are listed

2. Check required secrets are set:
   - Run: `supabase secrets list`
   - Verify `RESEND_API_KEY`, `FRONTEND_URL`, and `OWNER_EMAIL` are configured

3. Check backend environment variables:
   - Verify `SUPABASE_URL` and `SUPABASE_ANON_KEY` are set in backend .env

4. Review Edge Function code for correct FRONTEND_URL usage:
   - Confirm tracking links will point to correct domain (elisbakery.com or dev URL)

Report any missing configuration before proceeding to testing.
  </action>
  <verify>
Run the following commands and confirm expected output:
1. `supabase functions list` - output includes both `send-order-confirmation` and `send-ready-notification` with status "Active"
2. `supabase secrets list` - output includes `RESEND_API_KEY`, `FRONTEND_URL`, `OWNER_EMAIL`
3. `grep -E "^SUPABASE_URL=|^SUPABASE_ANON_KEY=" backend/.env` - both variables present with non-empty values
  </verify>
  <done>
Infrastructure verified ready for email testing. All Edge Functions deployed, all secrets configured, backend env vars present.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Manual email testing - Test Matrix</name>
  <action-required>
Place 4 test orders covering the complete test matrix. This requires payment processing which cannot be automated.

**Test Matrix:**

| Test # | Language | Delivery Option | Test Steps |
|--------|----------|-----------------|------------|
| 1 | English | Pickup | Set site to EN, place order with pickup |
| 2 | English | Delivery | Set site to EN, place order with delivery |
| 3 | Spanish | Pickup | Set site to ES, place order with pickup |
| 4 | Spanish | Delivery | Set site to ES, place order with delivery |

**For each test order:**

1. **Before placing order:**
   - Note start time: __:__
   - Set language toggle (EN or ES) on site
   - Use incognito browser to avoid cached language

2. **Place test order via /order page:**
   - Customer name: "Test Customer [Test#]"
   - Email: Your personal email address
   - Phone: +1 (610) 555-1234
   - Test data for cake (any size/filling/theme)
   - For delivery tests: use "123 Test St, Norristown, PA 19401"
   - Complete payment (use test card if in sandbox mode)
   - Note order number: ORD-____

3. **Verify Order Confirmation Email:**
   - Check inbox (wait up to 60 seconds)
   - Check spam folder if not in inbox
   - Verify: Language matches, order details correct, tracking link works
   - Note time received: __:__
   - Calculate delay: ___ seconds
   - Record: PASS/FAIL + any issues

4. **Change order status to "ready":**
   - Navigate to /front-desk or /owner-dashboard
   - Find order by order number
   - Change status to "ready"
   - Note time of status change: __:__

5. **Verify Ready Notification Email:**
   - Check inbox (wait up to 60 seconds)
   - Check spam folder if not in inbox
   - Verify: Language matches, pickup/delivery info correct, tracking link works
   - For pickup: Shows bakery address
   - For delivery: Shows customer's delivery address
   - Note time received: __:__
   - Calculate delay: ___ seconds
   - Record: PASS/FAIL + any issues

6. **Cancel test order to clean up:**
   - Change status to cancelled in dashboard

**Record all results in a simple table format to share with Claude.**
  </action-required>
  <resume-signal>
Share test results as a table showing: Test#, Order#, Confirmation Email (PASS/FAIL + delay in seconds), Ready Email (PASS/FAIL + delay in seconds), Spam? (yes/no), Issues found
  </resume-signal>
  <done>
All 4 test scenarios executed. Test results table provided with timing data for each email delivery.
  </done>
</task>

<task type="auto">
  <name>Task 3: Debug any failures and create troubleshooting guide</name>
  <files>
    .planning/phases/02-verify-order-emails/02-TROUBLESHOOTING.md
    .planning/phases/02-verify-order-emails/02-VERIFICATION.md
  </files>
  <action>
Based on test results from Task 2:

**If all tests passed:**
Create the troubleshooting guide documenting:
1. How to verify Edge Functions are deployed (`supabase functions list`)
2. How to check function logs for errors (Dashboard navigation)
3. How to verify secrets are set (`supabase secrets list`)
4. Common issues and solutions from RESEARCH.md:
   - Email landing in spam (check SPF/DKIM in Resend dashboard)
   - Edge function invocation failures (missing secrets, not deployed)
   - Wrong language in email (check customer_language field)
   - Missing order details (check order data passed to function)
   - Delivery delay beyond 1 minute (check function execution time)

**If any tests failed:**
1. Check Supabase Edge Function logs for errors
2. Check Resend dashboard for delivery status
3. Verify order record has correct customer_language value
4. Debug and fix issues
5. Re-test affected scenarios
6. Document the issue and fix in troubleshooting guide

Write troubleshooting guide to: `.planning/phases/02-verify-order-emails/02-TROUBLESHOOTING.md`

Create verification results document at: `.planning/phases/02-verify-order-emails/02-VERIFICATION.md`
This file must contain:
- Test matrix results table (all 4 scenarios)
- Timing measurements for each email
- Pass/fail status for each truth from must_haves
- Any issues found and resolutions
  </action>
  <verify>
Run these commands and confirm expected output:
1. `wc -l .planning/phases/02-verify-order-emails/02-TROUBLESHOOTING.md` - at least 50 lines
2. `wc -l .planning/phases/02-verify-order-emails/02-VERIFICATION.md` - at least 30 lines
3. `grep -c "PASS\|FAIL" .planning/phases/02-verify-order-emails/02-VERIFICATION.md` - at least 7 (one per truth)
  </verify>
  <done>
Troubleshooting guide created (50+ lines). Verification document created (30+ lines) with all test results.
  </done>
</task>

<task type="auto">
  <name>Task 4: Validate all must_haves truths against test results</name>
  <files>.planning/phases/02-verify-order-emails/02-VERIFICATION.md</files>
  <action>
Review the test results and explicitly validate each truth from must_haves against the recorded data.

For each truth, append a validation section to 02-VERIFICATION.md:

## Must-Haves Validation

| Truth | Evidence | Status |
|-------|----------|--------|
| Order confirmation within 60s | Test 1: Xs, Test 2: Xs, Test 3: Xs, Test 4: Xs (all <= 60) | PASS/FAIL |
| Ready notification within 60s | Test 1: Xs, Test 2: Xs, Test 3: Xs, Test 4: Xs (all <= 60) | PASS/FAIL |
| English orders get English emails | Test 1 & 2: confirmed EN subject/body | PASS/FAIL |
| Spanish orders get Spanish emails | Test 3 & 4: confirmed ES subject/body | PASS/FAIL |
| Pickup shows pickup location | Test 1 & 3: bakery address in ready email | PASS/FAIL |
| Delivery shows delivery address | Test 2 & 4: customer address in ready email | PASS/FAIL |
| Emails not in spam | All 8 emails in inbox (not spam) | PASS/FAIL |

**Threshold validation:**
- If any confirmation email delay > 60 seconds: FAIL that truth
- If any ready notification delay > 60 seconds: FAIL that truth
- Calculate: min, max, average delay for each email type

Final verdict: ALL must_haves PASS = Phase verified. Any FAIL = document in issues section.
  </action>
  <verify>
Run: `grep -E "^\| .* \| PASS$|^\| .* \| FAIL$" .planning/phases/02-verify-order-emails/02-VERIFICATION.md | wc -l`
Output should be at least 7 (one validation row per truth).
  </verify>
  <done>
All 7 truths explicitly validated against test data. Each has PASS/FAIL status with supporting evidence. 02-VERIFICATION.md contains complete must_haves validation section.
  </done>
</task>

</tasks>

<verification>
Phase verification:
1. All 4 test scenarios (EN/ES x pickup/delivery) pass
2. Order confirmation emails arrive within 60 seconds
3. Ready notification emails arrive within 60 seconds
4. Email content is correct (language, order details, tracking link)
5. Emails do not land in spam folder
6. Troubleshooting guide exists at `.planning/phases/02-verify-order-emails/02-TROUBLESHOOTING.md`
7. Verification document exists at `.planning/phases/02-verify-order-emails/02-VERIFICATION.md`
8. All 7 must_haves truths explicitly validated with PASS/FAIL status
</verification>

<success_criteria>
- 4/4 test scenarios pass (order confirmation + ready notification for each)
- All emails arrive within 60 seconds of trigger
- No emails land in spam
- Troubleshooting guide created for future debugging (50+ lines)
- Verification document created with test results (30+ lines)
- All 7 must_haves truths validated with evidence
- Any issues found are fixed and documented
</success_criteria>

<output>
After completion, create `.planning/phases/02-verify-order-emails/02-01-SUMMARY.md`
</output>
