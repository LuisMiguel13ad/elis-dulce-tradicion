---
phase: 01-contact-form-emails
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/support.ts
  - supabase/functions/send-ready-notification/index.ts
  - supabase/functions/send-order-confirmation/index.ts
  - supabase/functions/send-contact-notification/index.ts
autonomous: false

user_setup:
  - service: supabase
    why: "Edge function secrets required for email delivery"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
      - name: OWNER_EMAIL
        source: "Set to info@elisbakery.com"
      - name: FRONTEND_URL
        source: "Set to https://elisbakery.com"
    dashboard_config:
      - task: "Set secrets via Supabase CLI"
        location: "Run: supabase secrets set RESEND_API_KEY=re_xxx OWNER_EMAIL=info@elisbakery.com FRONTEND_URL=https://elisbakery.com"

must_haves:
  truths:
    - "Contact form submission triggers email to owner at info@elisbakery.com"
    - "Contact form submission triggers auto-reply to customer"
    - "Ready notification email shows correct address: 324 W Marshall St, Norristown, PA 19401"
    - "All email templates show correct phone: (610) 279-6200"
    - "Email failures do not block form submission success"
  artifacts:
    - path: "src/lib/support.ts"
      provides: "Edge function invocation after form submit"
      contains: "supabase.functions.invoke"
    - path: "supabase/functions/send-ready-notification/index.ts"
      provides: "Ready notification with correct address"
      contains: "324 W Marshall St"
    - path: "supabase/functions/send-order-confirmation/index.ts"
      provides: "Order confirmation with correct phone"
      contains: "(610) 279-6200"
  key_links:
    - from: "src/lib/support.ts"
      to: "send-contact-notification edge function"
      via: "supabase.functions.invoke('send-contact-notification', ...)"
      pattern: "supabase\\.functions\\.invoke.*send-contact-notification"
---

<objective>
Wire up contact form email notifications and fix content inconsistencies in email templates.

Purpose: Contact form submissions currently save to database but never send email notifications. The edge function exists but is never called. This plan connects the existing components and fixes placeholder/phone number issues.

Output: Working email notification flow where form submission triggers owner notification + customer auto-reply, with all templates showing correct business info.
</objective>

<execution_context>
@/Users/luismiguel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/luismiguel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-contact-form-emails/01-RESEARCH.md

# Key source files
@src/lib/support.ts
@supabase/functions/send-contact-notification/index.ts
@supabase/functions/send-ready-notification/index.ts
@supabase/functions/send-order-confirmation/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire edge function call in submitContactForm</name>
  <files>src/lib/support.ts</files>
  <action>
Add edge function invocation after successful database insert in the `submitContactForm()` function.

After the successful `.select().single()` call (around line 119-126), add:

```typescript
// Import at top of file (add to existing imports)
import { FunctionsHttpError, FunctionsRelayError, FunctionsFetchError } from '@supabase/supabase-js';

// After successful insert, invoke edge function for email notifications
// Email failures should NOT block form submission - database is source of truth
try {
  const { error: emailError } = await supabase.functions.invoke(
    'send-contact-notification',
    {
      body: { submission }
    }
  );

  if (emailError) {
    // Log but don't throw - form submission already succeeded
    console.error('Email notification failed:', emailError);
  }
} catch (emailInvokeError) {
  // Network/relay failures - log but don't block
  if (emailInvokeError instanceof FunctionsRelayError ||
      emailInvokeError instanceof FunctionsFetchError) {
    console.error('Email function network error (will retry on next submission):', emailInvokeError);
  } else {
    console.error('Email notification error:', emailInvokeError);
  }
}
```

Key requirements:
- Place the edge function call AFTER the successful database insert returns
- Wrap in try/catch to prevent email failures from blocking form submission
- Import the Supabase error types at the top of the file
- Log errors but do NOT throw them - the form submission succeeded if database insert worked
  </action>
  <verify>
1. Check file compiles: `cd /Users/luismiguel/Desktop/elis-dulce-tradicion && npx tsc --noEmit src/lib/support.ts 2>&1 | head -20`
2. Verify the invoke call is present: `grep -n "supabase.functions.invoke" src/lib/support.ts`
3. Verify error imports: `grep -n "FunctionsHttpError\|FunctionsRelayError\|FunctionsFetchError" src/lib/support.ts`
  </verify>
  <done>
submitContactForm() calls supabase.functions.invoke('send-contact-notification') after successful database insert, with proper error handling that logs but doesn't throw on email failures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix placeholder address in ready notification</name>
  <files>supabase/functions/send-ready-notification/index.ts</files>
  <action>
Replace all placeholder address text with the correct business address.

Find and replace in the file:
- `[Your Address Here]` -> `324 W Marshall St, Norristown, PA 19401`
- `[Tu Dirección Aquí]` or `[Tu Direccion Aqui]` -> `324 W Marshall St, Norristown, PA 19401`

Also fix the phone number in this file:
- `(610) 910-9067` -> `(610) 279-6200`

There are 4 locations to fix (2 in HTML templates, 2 in text templates):
1. English HTML: line ~115 area
2. Spanish HTML: line ~168 area
3. English text: line ~213 area
4. Spanish text: line ~247 area

Plus phone number references in contact sections.
  </action>
  <verify>
1. No placeholders remain: `grep -n "\[Your Address\|Tu Dirección\|Tu Direccion" supabase/functions/send-ready-notification/index.ts`
2. Correct address present: `grep -c "324 W Marshall St" supabase/functions/send-ready-notification/index.ts` (should be 4)
3. Correct phone present: `grep -c "(610) 279-6200" supabase/functions/send-ready-notification/index.ts`
4. No old phone: `grep -c "(610) 910-9067" supabase/functions/send-ready-notification/index.ts` (should be 0)
  </verify>
  <done>
send-ready-notification edge function shows "324 W Marshall St, Norristown, PA 19401" and "(610) 279-6200" in all 4 template locations (English/Spanish HTML and text).
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix phone number in order confirmation and contact notification</name>
  <files>
supabase/functions/send-order-confirmation/index.ts
supabase/functions/send-contact-notification/index.ts
  </files>
  <action>
Fix the phone number in both email template files.

**send-order-confirmation/index.ts:**
Replace all instances of `(610) 910-9067` with `(610) 279-6200`

Locations (approximate):
- Line ~137-139: English HTML contact section
- Line ~194-196: Spanish HTML contact section
- Line ~224-226: English text contact section
- Line ~254-256: Spanish text contact section

**send-contact-notification/index.ts:**
Replace all instances of `(610) 910-9067` with `(610) 279-6200`

Location:
- Line ~117: Customer auto-reply contact section

Both files should use the consistent phone number (610) 279-6200.
  </action>
  <verify>
1. Order confirmation has correct phone: `grep -c "(610) 279-6200" supabase/functions/send-order-confirmation/index.ts` (should be 4)
2. Order confirmation no old phone: `grep -c "(610) 910-9067" supabase/functions/send-order-confirmation/index.ts` (should be 0)
3. Contact notification has correct phone: `grep -c "(610) 279-6200" supabase/functions/send-contact-notification/index.ts` (should be 1)
4. Contact notification no old phone: `grep -c "(610) 910-9067" supabase/functions/send-contact-notification/index.ts` (should be 0)
  </verify>
  <done>
All email templates (order confirmation, contact notification, ready notification) show consistent phone number (610) 279-6200.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Contact form email notification wiring and content fixes:
1. submitContactForm() now calls send-contact-notification edge function after database insert
2. All email templates show correct address: 324 W Marshall St, Norristown, PA 19401
3. All email templates show correct phone: (610) 279-6200
  </what-built>
  <how-to-verify>
**Before testing, ensure secrets are set:**
```bash
supabase secrets set RESEND_API_KEY=your_key OWNER_EMAIL=info@elisbakery.com FRONTEND_URL=https://elisbakery.com
supabase functions deploy send-contact-notification
```

**Test the contact form flow:**
1. Go to the contact page on the website
2. Fill out and submit the contact form with a test email you can check
3. Verify within 1-2 minutes:
   - [ ] Owner receives email at info@elisbakery.com with submission details
   - [ ] Customer (test email) receives auto-reply confirmation
   - [ ] Form shows success message (even if email silently fails)
4. Check email content shows:
   - [ ] Phone: (610) 279-6200 (not 910-9067)
   - [ ] No placeholder text like "[Your Address Here]"

**If edge function not deployed yet:**
- Code changes are complete - verify with grep commands from task verification
- Deploy will happen when CONFIG-01 is addressed
  </how-to-verify>
  <resume-signal>Type "approved" if emails work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All code verification commands:

```bash
cd /Users/luismiguel/Desktop/elis-dulce-tradicion

# 1. Edge function call wired up
grep -n "supabase.functions.invoke.*send-contact-notification" src/lib/support.ts

# 2. Error handling imports present
grep -n "FunctionsRelayError\|FunctionsFetchError" src/lib/support.ts

# 3. No placeholder addresses remain
grep -rn "\[Your Address\|\[Tu Dirección\|\[Tu Direccion" supabase/functions/

# 4. Correct address in ready notification (should show 4 matches)
grep -c "324 W Marshall St" supabase/functions/send-ready-notification/index.ts

# 5. Correct phone everywhere (should show matches in all 3 function files)
grep -rn "(610) 279-6200" supabase/functions/

# 6. No old phone anywhere (should show 0 matches)
grep -rn "(610) 910-9067" supabase/functions/
```
</verification>

<success_criteria>
1. `submitContactForm()` in src/lib/support.ts contains `supabase.functions.invoke('send-contact-notification', ...)` call
2. Error handling wraps the invoke call - email failures logged but don't throw
3. No placeholder text ("[Your Address Here]", etc.) in any edge function file
4. Address "324 W Marshall St, Norristown, PA 19401" appears in send-ready-notification (4 times)
5. Phone "(610) 279-6200" appears in all 3 edge function files
6. Phone "(610) 910-9067" appears in 0 edge function files
7. Human verifies email flow works end-to-end (checkpoint passed)
</success_criteria>

<output>
After completion, create `.planning/phases/01-contact-form-emails/01-01-SUMMARY.md`
</output>
